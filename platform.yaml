#   Copyright 2016-2017 Amazon.com, Inc. or its affiliates. All Rights Reserved.
#
#   Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file except in compliance with the License. A copy of the License is located at
#
#   http://aws.amazon.com/apache2.0/
#
#   or in the "license" file accompanying this file. This file is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the specific language governing permissions and limitations under the License.

version: "1.0"

provisioner:
  type: packer
  template: di_platform.json
  flavor: ubuntu1604

metadata:
  maintainer: <Serhii Matrunchyk>
  description: DI Platform Container.
  operating_system_name: Ubuntu
  operating_system_version: 16.04
  programming_language_name: PHP
  programming_language_version: 7.1
  framework_name: Laravel
  framework_version: 5.x.x
  app_server_name: "none"
  app_server_version: "none"

option_definitions:
  - namespace: "aws:elasticbeanstalk:sns:topics"
    option_name: "Notification Endpoint"
    ## CHANGE IT
    default_value: "serhii@digitalidea.studio"

  - namespace: "aws:elasticbeanstalk:application"
    option_name: "Application Healthcheck URL"
    default_value: "/eb-status"

  - namespace: "aws:elasticbeanstalk:environment"
    option_name: "EnvironmentType"
    default_value: "LoadBalanced"
    option_name: "LoadBalancerType"
    default_value: "application"

  ## Default HTTP process
  - namespace: "aws:elasticbeanstalk:environment:process:default"
    option_name: "HealthCheckPath"
    default_value: "/eb-status"

  ## HTTPS Socket process
  - namespace: "aws:elasticbeanstalk:environment:process:socket"
    option_name: "HealthCheckPath"
    default_value: "/socket.io/?transport=polling"
    option_name: "StickinessEnabled"
    default_value: "true"
    option_name: "StickinessLBCookieDuration"
    default_value: "604800"

  ## HTTP listener (default)
  - namespace: "aws:elbv2:listener:default"
    option_name: "DefaultProcess"
    default_value: "default"
    option_name: "ListenerEnabled"
    default_value: "true"

  ## HTTPS listener support
  - namespace: "aws:elbv2:listener:443"
    option_name: "DefaultProcess"
    default_value: "https"
    option_name: "Protocol"
    default_value: "HTTPS"
    option_name: "Rules"
    default_value: "Socket"
    option_name: "SSLCertificateArns"
    ## CHANGE IT
    default_value: "arn:aws:acm:us-east-1:630954786316:certificate/b8703adc-4e57-4001-99aa-9d0d922cc4fc"

  ## Socket.io rule
  - namespace: "aws:elbv2:listenerrule:socket"
    option_name: "PathPatterns"
    default_value: "/socket.io/*"
    option_name: "Priority"
    default_value: "1"
    option_name: "Process"
    default_value: "socket"

  ## Prevent Beanstalk from adding SSH ingress to instance SG
  - namespace: "aws:autoscaling:launchconfiguration"
    option_name: "SSHSourceRestriction"
    ## CHANGE IT
    default_value: "tcp, 22, 22, 127.0.0.1/32"

  ## Run only one instance during install
  - namespace: "aws:autoscaling:asg"
    option_name: "MaxSize"
    default_value: "1"

  ## Faster deployments during dev work
  - namespace: "aws:autoscaling:updatepolicy:rollingupdate"
    option_name: "RollingUpdateEnabled"
    default_value: "false"

  - namespace: "aws:elasticbeanstalk:command"
    option_name: "DeploymentPolicy"
    default_value: "AllAtOnce"
    option_name: "IgnoreHealthCheck"
    default_value: "true"

  - namespace: "aws:elasticbeanstalk:monitoring"
    option_name: "Automatically Terminate Unhealthy Instances"
    default_value: "false"

